#!/bin/sh

SIGTMP="/tmp/sigtemp"
LEDIR="/sys/class/leds/" #Needs trailing /
LED3="wrt160nl:blue:wlan"
LED2="wrt160nl:amber:wps"
LED1="wrt160nl:blue:wps"

TRH1=40
TRH1B=45

TRH2=50
TRH2B=55

TRH3=60
TRH3B=65

TRH4=70
TRH4B=75

OLDVAL=0


#echo begin

clear1() {
        echo 0 > ${LEDIR}${1}/brightness
}

set1() {
        echo 1 > ${LEDIR}${1}/brightness
}


blink1() {
        clear1 $1
        set1 $1
        echo heartbeat > ${LEDIR}${1}/trigger
}

clear_all() {
        clear1 $LED1
        clear1 $LED2
        clear1 $LED3
}


clear_all
while true
        do
if [ `iwconfig $1 | grep -c $1` -gt 0 ]
then
        iw dev $1 station dump | grep 'signal' | cut -d - -f 2 | cut -d d -f 1 > $SIGTMP
#echo "----------------------"
#echo "oldval $OLDVAL"        
        REZ="0"
        while read line
                do 
                if [ $line -gt $REZ ]
                        then
                        REZ=$line
                fi
        done < $SIGTMP
#echo "rez $REZ"
        if [ $REZ -ne 0 ]; then
                if [ $REZ -ne $OLDVAL ]; then
                        clear_all
                        if [ $REZ -le $TRH1 ]; then
#echo "level1 $REZ"
                                set1 $LED1
                                set1 $LED3
                        else
                        if [ $REZ -le $TRH1B ]; then
#echo "level1b"
                                blink1 $LED1
                                set1 $LED3
                        else
                                if [ $REZ -le $TRH2 ]; then
#echo "level2"
	                                set1 $LED1
                                        set1 $LED2
                                        set1 $LED3
                                else
                                if [ $REZ -le $TRH2B ]; then
#echo "level2b"
                                        blink1 $LED1
                                        blink1 $LED2
                                        set1 $LED3
                                else
                                        if [ $REZ -le $TRH3 ]; then
#echo "level3"
                                                set1 $LED2
	                                        set1 $LED3
                                        else
                                        if [ $REZ -le $TRH3B ]; then
#echo "level3b"
                                                blink1 $LED2
                                                set1 $LED3
                                        else
                                                if [ $REZ -le $TRH4 ]; then
#echo "level4"
                                                        set1 $LED3               
                                                else
                                                if [ $REZ -le $TRH4 ]; then
#echo "level4b"
                                                        blink1 $LED3                            
                                                fi
                                                fi
                                        fi
                                        fi
                                fi
                                fi
                        fi
                        fi
                        OLDVAL=$REZ
                fi
        else
                clear_all
        fi
fi
sleep 2
done

