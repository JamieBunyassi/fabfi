_Note: currently, we are using "Linksys WRT160NL" as "head nodes" for the FabFi network_

==How to Flash a Head Node:==

===Prerequisites===

*Hardware you will need:*
 * A serial cable (or, for most modern users, a usb --> serial connection)
 * A Linksys WRT160NL Router

*Software you will need:*
 * The latest image to be flashed
   * (This can either be built using openWRT and the latest SVN download, or by going __here__ to the downloads page to find the latest stable build)
 * A TFTP program
   * Linux: minicom (sudo apt-get tftp)
   * Windows: google for "how to enable windows tftp" (though we found we couldn't really ever get tftp working on windows - the commands are too weird)
 * A Serial program ("hyperterminal")
   * Linux: minicom (sudo apt-get minicom), then HowToSetUpSerialMinicomLinux
   * Windows: google for "windows hyperterminal alternatives" (we used "Tera Term", recommended from http://helpdeskgeek.com/windows-7/windows-7-hyperterminal/ and it worked great)

_Note: in our experiences, we found this all easier to do in linux, and even easier if you have both windows and linux. We were able to easily connect_

===The Procedure===
 # Open up the Linksys device & connect your computer to the Linksys Device via serial cable (image)
 # Launch your hyperterminal (serial) program and set the baud rate to 115200. Or, if you are in linux, HowToSetUpSerialMinicomLinux
 # Restart the router (by power cycling)
 # You should see lots of things start printing in the serial connection
   * (If the text is not understandable (lots of black blocks, etc.) it means you are either at the wrong baud rate, or the physical serial connection is not good. Try fiddling with the wires)
 # Immediately start pressing any key (i used 'enter') - because the serial terminal will soon tell you "hit any key to stop autoboot" - but only give you a fraction of a second to do so
 # Assuming you have done this correctly, you should see the console message change to "ar7100>" (or something like that) and it should be ready for you to write commands
 # Enter the command *"upgrade code.bin"*

Ok take a deep breath (and keep the serial connection open) - now we will enter the tftp side of things. _Note: "tftp" stands for 'trivial ftp', and is used for simple transfer protocols - like flashing a device._

Now..
 # Connect a serial cable to port 4 on the linksys device
 # Change your ip (or if linux, your network connection) to the following settings:
   # Set the wired connection mode to "manual" (instead of dhcp)
   # ip: 192.168.1.(2-254) (ie. 192.168.1.254)
   # netmask: 255.255.255.0
   # default gateway: 192.168.1.1
 # Make sure you are connected and your computer can see the ethernet connection to the linksys

 # Open up a new console
 # Navigate to the folder where you have saved the file "openwrt-ar71xx-wrt160nl-squashfs-factory.bin" 
   * (btw you can rename this to "code.bin" or something else more easily read)
 # Now type:
   # *"tftp 192.168.1.1"* (connects to the device)
   # *"tftp>binary"* (sets program mode to binary)
   # *"tftp>rexmt 1"*
   # *"tftp>trace on"* (shows you output)
   # *"tftp>put code.bin"* (or type "put (filename).bin code.bin" if you didn't rename the file to "code.bin")

As the tftp starts pushing data to the router, you should be able to read the router's responses in the serial window. 

When the tftp finishes sending all of the commands, you should
 * Exit tftp
 * Unplug the ethernet cable from the router

There should come a point when the router indicates "done" (a successful flash) on the serial console.

Whala! You have now re-programmed (flashed) a headnode. Now it's on to configuration!! HowToConfigureHeadNode

Note: if you are continuing directly to configuring the head node (which you probably should), then you should type:
 * "reboot" (which will restart the router)
 * You should see many things print out (you may have to hit 'enter' once or twice if it seems to stop for a long time) - and eventually get to some text that says "open wrt" and "wirless freedom". This is good. Your router is now flashed properly and ready to roll


====Possible Errors While Flashing:====
Problems:
 * While re-flashing, on the serial console something is printed out about "bad code sector" (or something serial) OR
 * On reboot, the device never finishes starting up, and (despite you trying to press enter a couple times) will never get to the "open wrt wirless freedom" screen.

Diagnosis:
 * Possible incomplete or corrupt code download OR
 * Image too old

Solution: 
  * Check to make sure you have the correct .bin file (the flash image)
    * You should have the flash image - not the sys-upgrade image
  * Try downloading the .bin file again (it may have gotten corrupted on download
    * Note: firefox is better for downloading than chrome
  * Try contacting the Fab Fi admins to get the latest image - you may have an image that's too old.