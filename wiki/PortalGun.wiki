= Introduction =

PortalGun is the fabfi mesh network access controller. 


== Bump OpenWRT iptables to 1.4.12.1 ==

The standard iptables in OpenWRT backfire & trunk does not include support for the tproxy modules we need to redirect client requests to the portal splash page or transparent proxy.

  * Edit: package/iptables/Makefile
  {{{
  #PKG_VERSION:=1.4.10
  PKG_VERSION:=1.4.12.1

  #PKG_MD5SUM:=f382fe693f0b59d87bd47bea65eca198
  PKG_MD5SUM:=b08a1195ec2c1ebeaf072db3c55fdf43
  }}}

  * Run:   TODO update patches for 1.4.12.1
  {{{
  rm package/iptables/patches/010-multiport-linux-2.4-compat.patch
  rm package/iptables/patches/011-recent-add-reap.patch
  rm package/iptables/patches/020-iptables-disable-modprobe.patch
  rm package/iptables/patches/100-bash-location.patch
  }}}


== Package Compilation ==

  * Edit: feeds.conf.default
  {{{
  src-svn fabfi http://fabfi.googlecode.com/svn/trunk/openwrt/package-scripts
  src-svn afrimesh http://afrimesh.googlecode.com/svn/trunk/package-scripts/openwrt
  }}}

  * Run:
  {{{
  ./scripts/feeds update fabfi afrimesh
  ./scripts/feeds/install portalgun

  make menuconfig

      Network -> Captive Portals -> portalgun 

  make
  }}}


== Installation == 

  * Run on head node:
  {{{
  opkg install portalgun

  uci add lucid villagebus
  uci set lucid.villagebus="VillagebusPublisher"
  uci set lucid.villagebus.name="Villagebus Publisher"
  uci set lucid.villagebus.home=1
  uci add_list lucid.villagebus.virtual="/villagebus"

  uci add lucid splashroot
  uci set lucid.splashroot="VillagebusPublisher"
  uci set lucid.splashroot.name="portalgun splash"
  uci set lucid.splashroot.home=1
  uci set lucid.splashroot.physical="/splash"

  uci add lucid splash
  uci set lucid.splash="daemon"
  uci set lucid.splash.slave="httpd"
  uci set lucid.splash.address=8001
  uci set lucid.splash.publisher="splashroot"
  uci set lucid.splash.nokeepalive=1
  uci set lucid.splash.memlimit=1572864
  uci set lucid.splash.enabled=1

  uci add_list lucid.httpd.supports="VillagebusPublisher"
  uci add_list lucid.https.publisher="villagebus"
  }}}


  * Edit on head node: /etc/haproxy.cfg
  {{{
  # Global parameters
  global
        #log 10.0.0.1 daemon info
        maxconn 32000
        ulimit-n 65535
        uid 0
        gid 0
        #chroot /var/run/haproxy/
        #daemon
        debug
        #nbproc 2

  defaults
        log global
        mode    http
        contimeout      4000
        clitimeout      42000
        srvtimeout      43000
        balance roundrobin
        stats enable                    
        stats uri /stats                
        #stats realm HA_Stats           
        #stats auth username:password   

  listen portalgun_splash 
        bind 2001:470:8c0e:fab::1:3129 transparent
        mode http
        option forwardfor
        reqadd Foo-Header:\ plonk
        server splash01 192.168.20.78:8001

  listen transparent_proxy
        bind 2001:470:8c0e:fab::1:3128 transparent 
        mode http
        option forwardfor
        option http-use-proxy-header
        server proxy01 192.168.20.77:3128
  }}}

== Configuration ==


== Hacking == 