<wiki:toc max_depth="4" />
= Introduction =
The Fabfi server is a cloud-hosted device that houses the authentication database and Management/Monitoring web GUI for the network.  The current version runs on Ubuntu 10.04 Server (i386).  This page provides configuration instructions for building the server from bare metal.

== OS Installation ==

  * Used U10.04 server i386, 
  * set up disk with LVM.  
  * system drive 50% of disk (=10GB)
  * 256M RAM
  * No other disk specified at this time
  * No proxy server
  * Install Security Updates Automatically
  * Installed Packages During OS Install
    * OpenSSH Server
  * Installed GRUB

== Install 3rd Party Software ==

=== Install mysql-server ===

{{{
sudo apt-get install mysql-server
}}}

  * Select a root user and password (it doesn't matter for our purposes)
  * log into mysql

{{{
mysql --user root -p
}}}

  * Set up a user and password for radius, then create the radiusdb

{{{
mysql> CREATE USER 'radius'@'localhost' IDENTIFIED BY 'some_pass';
mysql> GRANT ALL PRIVILEGES ON *.* TO 'radius'@'localhost'
    ->     WITH GRANT OPTION;
mysql> CREATE DATABASE radiusdb;
}}}

=== Install Freeradius ===

{{{
sudo apt-get install freeradius freeradius-mysql
}}}

Then edit 

{{{
/etc/freeradius/radiusd.conf
}}}

Uncomment 

{{{
$INCLUDE sql.conf
}}}

Set proxy_requests to no and comment the include

{{{
proxy_requests  = no
#$INCLUDE proxy.conf
}}}

Then edit 

{{{
/etc/freeradius/sites-enabled/default
}}}

and uncomment all references to "sql"

Then edit

{{{
/etc/freeradius/sql.conf
}}}

and change username and password to match the user and password you created above.  Also change database name to 'radusdb' because this is the db name that will be used by daloradius below.

{{{
        # Connection info:
        server = "localhost"
        #port = 3306
        login = "radius"
        password = "cisco123"

        # Database table configuration for everything except Oracle
        radius_db = "radiusdb"
}}}

Then edit 

{{{
/etc/clients.conf
}}}

set your NAS secret

{{{
secret = yoursecret
}}}

and add 

{{{
client 10.0.0.0/8 {
  secret = cisco123
  shortname = fabfi-portal
}

client 41.0.0.0/8 {
  secret = cisco123
  shortname = fabfi-cloud
}
}}}

at the end of the file.


=== Install Daloradius ==

{{{
sudo apt-get apache2 php-db php-pear php5-mysql
}}}

Download the latest Daloradius distribution:
{{{ 
sudo cd /etc/ && wget http://downloads.sourceforge.net/project/daloradius/daloradius/daloradius-0.9-8/daloradius-0.9-8.tar.gz?r=http%3A%2F%2Fsourceforge.net%2Fprojects%2Fdaloradius%2Ffiles%2Fdaloradius%2F&ts=1295083448&use_mirror=garr
}}}

Extract it to your webserver directory:

{{{
cd /var/www
sudo tar -xzf ~/daloradius-0.9-8.tar.gz
sudo mv daloradius-0.9-8 daloradius
}}}

Then Edit your config:

* Navigate to the settings file

{{{
cd daloradius/library
vi daloradius.conf.php
}}}

  * Specify Freeradius version
  * Specify database details.  The values you need to change from the defaults will be:

{{{
$configValues['DALORADIUS_VERSION'] = '0.9-8';
$configValues['FREERADIUS_VERSION'] = '2';
$configValues['CONFIG_DB_USER'] = 'root';  //Your database username
$configValues['CONFIG_DB_PASS'] = 'password';  //Your database password
$configValues['CONFIG_DB_NAME'] = 'radiusdb';  //The name of your database
$configValues['CONFIG_MAINT_TEST_USER_RADIUSSECRET'] = 'yoursecret';
}}}

  * The complete config will then look like this:

{{{
$configValues['DALORADIUS_VERSION'] = '0.9-8';
$configValues['FREERADIUS_VERSION'] = '2';
$configValues['CONFIG_DB_ENGINE'] = 'mysql';
$configValues['CONFIG_DB_HOST'] = '127.0.0.1';
$configValues['CONFIG_DB_USER'] = 'radius';
$configValues['CONFIG_DB_PASS'] = 'password';
$configValues['CONFIG_DB_NAME'] = 'radiusdb';
$configValues['CONFIG_DB_TBL_RADCHECK'] = 'radcheck';
$configValues['CONFIG_DB_TBL_RADREPLY'] = 'radreply';
$configValues['CONFIG_DB_TBL_RADGROUPREPLY'] = 'radgroupreply';
$configValues['CONFIG_DB_TBL_RADGROUPCHECK'] = 'radgroupcheck';
$configValues['CONFIG_DB_TBL_RADUSERGROUP'] = 'radusergroup';
$configValues['CONFIG_DB_TBL_RADNAS'] = 'nas';
$configValues['CONFIG_DB_TBL_RADPOSTAUTH'] = 'radpostauth';
$configValues['CONFIG_DB_TBL_RADACCT'] = 'radacct';
$configValues['CONFIG_DB_TBL_RADIPPOOL'] = 'radippool';
$configValues['CONFIG_DB_TBL_DALOOPERATOR'] = 'operators';
$configValues['CONFIG_DB_TBL_DALORATES'] = 'rates';
$configValues['CONFIG_DB_TBL_DALOHOTSPOTS'] = 'hotspots';
$configValues['CONFIG_DB_TBL_DALOUSERINFO'] = 'userinfo';
$configValues['CONFIG_DB_TBL_DALOUSERBILLINFO'] = 'userbillinfo';
$configValues['CONFIG_DB_TBL_DALODICTIONARY'] = 'dictionary';
$configValues['CONFIG_DB_TBL_DALOREALMS'] = 'realms';
$configValues['CONFIG_DB_TBL_DALOPROXYS'] = 'proxys';
$configValues['CONFIG_DB_TBL_DALOBILLINGPAYPAL'] = 'billing_paypal';
$configValues['CONFIG_DB_TBL_DALOBILLINGPLANS'] = 'billing_plans';
$configValues['CONFIG_DB_TBL_DALOBILLINGRATES'] = 'billing_rates';
$configValues['CONFIG_DB_TBL_DALOBILLINGHISTORY'] = 'billing_history';
$configValues['CONFIG_FILE_RADIUS_PROXY'] = '/etc/freeradius/proxy.conf';
$configValues['CONFIG_PATH_RADIUS_DICT'] = '';
$configValues['CONFIG_PATH_DALO_VARIABLE_DATA'] = '/var/www/daloradius/var';
$configValues['CONFIG_DB_PASSWORD_ENCRYPTION'] = 'cleartext';
$configValues['CONFIG_LANG'] = 'en';
$configValues['CONFIG_LOG_PAGES'] = 'no';
$configValues['CONFIG_LOG_ACTIONS'] = 'no';
$configValues['CONFIG_LOG_QUERIES'] = 'no';
$configValues['CONFIG_DEBUG_SQL'] = 'no';
$configValues['CONFIG_DEBUG_SQL_ONPAGE'] = 'no';
$configValues['CONFIG_LOG_FILE'] = '/tmp/daloradius.log';
$configValues['CONFIG_IFACE_PASSWORD_HIDDEN'] = 'no';
$configValues['CONFIG_IFACE_TABLES_LISTING'] = '25';
$configValues['CONFIG_IFACE_TABLES_LISTING_NUM'] = 'yes';
$configValues['CONFIG_IFACE_AUTO_COMPLETE'] = 'yes';
$configValues['CONFIG_MAINT_TEST_USER_RADIUSSERVER'] = '127.0.0.1';
$configValues['CONFIG_MAINT_TEST_USER_RADIUSPORT'] = '1812';
$configValues['CONFIG_MAINT_TEST_USER_NASPORT'] = '0';
$configValues['CONFIG_MAINT_TEST_USER_RADIUSSECRET'] = 'yoursecret';
}}}

Run the setup script for freeradius and daloradius:

{{{
mysql --user root -p radiusdb < /var/www/contrib/db/fr2-mysql-daloradius-and-freeradius.sql
}}}

=== Check your configuration ===

Stop freeradius service then run the configuration check:

{{{
sudo /etc/init.d/freeradius stop
sudo freeradius -X
}}}

You should see freeradius start up and the end of the startup message will look something like tis 

{{{
Listening on authentication address * port 1812
Listening on accounting address * port 1813
Ready to process requests.
}}}

once you have confirmed proper startup you can quit with ctrl+C, then start the service normally:

{{{
sudo /etc/init.d/freeradius start
}}}

=== Configure SSL for Apache ===

We did this by following the tutorial [http://library.linode.com/web-servers/apache/ssl-guides/using-ssl-ubuntu-10.04-lucid#use_a_self_signed_ssl_certificate_with_apache here].  The following is a screenscrape of my session:

{{{
ja@ja2:~$ sudo a2enmod ssl
[sudo] password for ja: 
Enabling module ssl.
See /usr/share/doc/apache2.2-common/README.Debian.gz on how to configure SSL and create self-signed certificates.
Run '/etc/init.d/apache2 restart' to activate new configuration!
ja@ja2:~$ sudo mkdir /etc/apache2/ssl
ja@ja2:~$ sudo openssl req -new -x509 -days 365 -nodes -out /etc/apache2/ssl/apache.pem -keyout /etc/apache2/ssl/apache.key
Generating a 1024 bit RSA private key
.............................................++++++
..............++++++
writing new private key to '/etc/apache2/ssl/apache.key'
-----
You are about to be asked to enter information that will be incorporated
into your certificate request.
What you are about to enter is what is called a Distinguished Name or a DN.
There are quite a few fields but you can leave some blank
For some fields there will be a default value,
If you enter '.', the field will be left blank.
-----
Country Name (2 letter code) [AU]:US
State or Province Name (full name) [Some-State]:MA
Locality Name (eg, city) []:Cambridge
Organization Name (eg, company) [Internet Widgits Pty Ltd]:JoinAfrica
Organizational Unit Name (eg, section) []:sandbox
Common Name (eg, YOUR name) []:John Doe
Email Address []:foo@bar.com
ja@ja2:~$ 
}}}

Then edit 

{{{
/etc/apache2/ports.conf
}}}

and add a new virtual host entry your IP address (or !* for all IPs)

{{{
NewVirtualHost *:443  <---you add this
Listen 443 <---should already be in the file
}}}

Then you will have to edit the virtual hosts file.  On our machine this file was

{{{
/etc/apache2/sites-enabled/000-default
}}}

In this file I copy the entire `<virtualhost>` block for `*:80` and then change the name of the new block to `*:443`.  I then added the following to the top of the block and changed the webmaster email.

{{{
     SSLEngine On
     SSLCertificateFile /etc/apache2/ssl/apache.pem
     SSLCertificateKeyFile /etc/apache2/ssl/apache.key
}}}

Then restart your werbserver:

{{{
$ sudo /etc/init.d/apache2 restart
}}}